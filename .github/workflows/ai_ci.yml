name: Remote Build Pipeline

on:
  push:
    branches: ["main"]

# Grants permission to save the Docker image to your profile
permissions:
  packages: write
  contents: read

jobs:
  # JOB 1: THE TEST RUNNER (Quality Control)
  test-code:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      # We install your tools and run pytest
      - name: Install & Test
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          pip install uv
          uv sync --frozen
          uv run pytest -v

  # JOB 2: THE BUILDER (Remote Docker)
  build-image:
    needs: test-code         # Only runs if tests pass
    runs-on: ubuntu-latest   # GitHub's server has Docker!
    steps:
      - uses: actions/checkout@v3

      # A. Log in to GitHub Container Registry (GHCR)
      - name: Log in to GitHub Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # B. Convert Repository Name to Lowercase (Docker requirement)
      - name: Lowercase Repo Name
        run: |
          echo "REPO=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      # C. Build and Push the Image
      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ env.REPO }}/ai-agent:latest